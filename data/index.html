<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" type="text/css" href="/style.css" media="all" />
    <title>Sensor graph</title>
    <link rel="shortcut icon" href="/favicon.ico" />
  </head>
  <body>
    <div style="text-align:center;">
      <b>AS7265 Spectroscopy</b>
    </div>
    <div class="chart-container" position: relative; height:350px; width:100%>
      <canvas id="myChart" width="600" height="400"></canvas>
    </div>
    <div style="text-align:center;">
      <p>
        <button id="toggleLogBtn" class="button">Start Logging</button>
        <button id="downloadLogfileBtn" class="button button-hidden">Download Logfile</button>
      </p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js" integrity="sha512-d9xgZrVZpmmQlfonhQUvTR7lMPtO7NkZMkA0ABN3PHCbKA5nqylQ/yWlFAyY6hYgdF1Qh6nYiuADWwKB4C2WSw==" crossorigin="anonymous"></script>
    <script>
      let loaded = false;
      const nms = [410,435,460,485,510,535,560,585,610,645,680,705,730,760,810,860,900,940];
      const vCH = ['vA','vB','vC','vD','vE','vF','vG','vH','vR','vI','vS','vJ','vT','vU','vV','vW','vK','vL'];

      let labelList = [];
      let dataList =[];
      for (const s of nms)
        labelList.push(`${s}`);
      let graphData = {
        labels: labelList,
        datasets: [{
          data: [],
          fill: false,
          borderColor : "rgba(192, 192, 192, 1.0)",
          backgroundColor : "rgba(192, 192, 192, 1.0)",
          showLine: true
        }]
      };
      let graphOptions = {
        scales: {
          xAxes: [{
            type: 'linear',
            position: 'bottom',
            gridLines: {
              color: "rgba(128, 128, 128, 0.5)"
            },
            ticks: {
              stepSize: 50
            }
          }],
          yAxes: [{
            type: 'linear',
            gridLines: {
              color: "rgba(128, 128, 128, 0.5)"
            }
          }]
        },
        elements: {
          line: {
            tension: 0.5 // disables bezier curves
          }
        },
        legend: {
          display: false
        },
        title: {
          display: true,
          text: 'Preparing...'
        }
      };
      let ctx = document.getElementById("myChart").getContext('2d');
      let chart = new Chart(ctx, {
        type: 'scatter',
        data: graphData,
        options: graphOptions
      });
      // chart.defaults.global.defaultFontColor = "rgba(192, 192, 192, 1.0)";

      let toggleLogButton = document.getElementById('toggleLogBtn');
      let downloadLogfileBtn = document.getElementById('downloadLogfileBtn');
      let ws = new WebSocket(`ws://${window.location.hostname}:81/`);
      ws.onmessage = function(evt) {
        let args = evt.data.split(' ');
        let arg0 = args[0];
        switch (arg0) {
        case 'loggingStarted':
          toggleLogBtn.innerHTML = 'Stop Logging';
          break;
        case 'loggingEnded':
          toggleLogBtn.innerHTML = 'Start Logging';
          break;
        case 'enableDownloadLogfile':
          let fname = args[1];
          downloadLogfileBtn.href = `${fname}`;
          downloadLogfileBtn.classList.add("m-fadeIn");
          break;
        case 'disableDownloadLogfile':
          downloadLogfileBtn.classList.remove("m-fadeIn");
          break;
        default:
          if (loaded) {
            let Time = new Date().toLocaleTimeString();
            dataList = [];
            for (let i = 0; i<vCH.length; i++)
              dataList.push({x: nms[i], y: JSON.parse(evt.data)[vCH[i]]});
            // console.log(dataList);
            chart.options.title.text = Time;
            chart.data.datasets[0].data = dataList;
            chart.update();
          }
        }
      };

      ws.onopen = function(evt) {
        console.log("ws: onpen");
      }
      
      ws.onclose = function(evt) {
        console.log("ws: onclose");
        ws.close();
      }

      ws.onerror = function(evt) {
        console.log(evt);
      }

      function initWebSocket() {

      }

      window.addEventListener('load', onLoad);

      function onLoad(event) {
        loaded = true;
        initWebSocket();
        initButtons();
      }

      function initButtons() {
        toggleLogBtn.addEventListener('click', onToggleLogBtn);
        downloadLogfileBtn.addEventListener('click', onDownloadLogfileBtn);
      }

      function onToggleLogBtn(){
        ws.send('onToggleLogBtn');
      }
      function onDownloadLogfileBtn() {
        // document.location.assign(downloadLogfileBtn.href);
        window.open(downloadLogfileBtn.href, '_blank');
      }
    </script>
  </body>
</html>
